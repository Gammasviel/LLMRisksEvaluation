{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>问题列表与评估</h2>
    </div>

    <!-- 唯一的表单，用于所有操作 -->
    <form method="POST" id="bulk-action-form">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>共 {{ questions|length }} 个问题</span>
                <div class="btn-group" role="group">
                    <!-- 批量更新按钮，提交到 bulk_action -->
                    <button type="submit" name="action" value="update" formaction="{{ url_for('questions.bulk_action') }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrow-repeat"></i> 批量更新
                    </button>
                    <!-- 批量删除按钮，提交到 bulk_action -->
                    <button type="submit" name="action" value="delete" formaction="{{ url_for('questions.bulk_action') }}" class="btn btn-sm btn-outline-danger" id="bulk-delete-btn">
                        <i class="bi bi-trash"></i> 批量删除
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th class="text-center" style="width: 5%;">
                                <input class="form-check-input" type="checkbox" id="select-all">
                            </th>
                            <th style="width: 10%;">ID</th>
                            <th>问题内容</th>
                            <th style="width: 20%;">维度</th>
                            <th style="width: 10%;">类型</th>
                            <th style="width: 10%;">状态</th>
                            <th style="width: 15%;" class="text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for question in questions %}
                        <tr id="question-row-{{ question.id }}">
                            <td class="text-center">
                                <input class="form-check-input question-checkbox" type="checkbox" name="question_ids" value="{{ question.id }}">
                            </td>
                            <td>{{ question.id }}</td>
                            <td>
                                <a href="{{ url_for('questions.question_detail', question_id=question.id) }}" class="text-decoration-none">
                                    {{ question.content[:50] }}{% if question.content|length > 50 %}...{% endif %}
                                </a>
                            </td>
                            <td>
                                {% set dim = question.dimension %}
                                {% if dim and dim.parent_ref and dim.parent_ref.parent_ref %}
                                    <small>{{ dim.parent_ref.parent_ref.name }} > {{ dim.parent_ref.name }} > {{ dim.name }}</small>
                                {% elif dim %}
                                    <small>{{ dim.name }}</small>
                                {% else %}
                                    <span class="text-muted small">未分配</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if question.question_type == 'objective' %}
                                <span class="badge bg-success">客观题</span>
                                {% else %}
                                <span class="badge bg-info">主观题</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge {% if question.answers|length > 0 %}bg-success{% else %}bg-warning text-dark{% endif %}" id="status-{{ question.id }}">
                                    {% if question.answers|length > 0 %}已评估{% else %}待评估{% endif %}
                                </span>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-outline-primary update-btn" data-id="{{ question.id }}">更新</button>
                                
                                <!-- 【修改点】单个删除按钮，使用 formaction 指向独立的删除路由 -->
                                <button type="submit" class="btn btn-sm btn-outline-danger" 
                                        formaction="{{ url_for('questions.delete_question', question_id=question.id) }}"
                                        onclick="return confirm('确定要永久删除这个问题吗？此操作不可撤销。');">删除</button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-4">暂无问题，请先 <a href="{{ url_for('questions.add_question') }}">添加题目</a>。</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </form>
</div>

<!-- JavaScript 部分保持不变 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 单个问题更新逻辑 ---
    document.querySelectorAll('.update-btn').forEach(button => {
        button.addEventListener('click', function() {
            const questionId = this.getAttribute('data-id');
            const statusBadge = document.getElementById('status-' + questionId);
            
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            if (statusBadge) {
                statusBadge.className = 'badge bg-secondary';
                statusBadge.textContent = '处理中';
            }
            
            fetch("{{ url_for('questions.update_questions') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `question_id=${questionId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'processing') {
                   setTimeout(() => {
                        this.disabled = false;
                        this.innerHTML = '更新';
                        if (statusBadge) {
                            statusBadge.className = 'badge bg-success';
                            statusBadge.textContent = '已评估';
                        }
                   }, 5000); 
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.disabled = false;
                this.innerHTML = '更新';
            });
        });
    });

    // --- 批量操作逻辑 ---
    const selectAllCheckbox = document.getElementById('select-all');
    const questionCheckboxes = document.querySelectorAll('.question-checkbox');
    const bulkActionForm = document.getElementById('bulk-action-form');
    
    if(selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            questionCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }

    if(bulkActionForm){
        bulkActionForm.addEventListener('submit', function(event) {
            // 获取是哪个按钮触发了提交
            const submitter = event.submitter;
            if (submitter && submitter.value === 'delete') {
                const selectedCount = document.querySelectorAll('.question-checkbox:checked').length;
                if (selectedCount === 0) {
                    alert('请至少选择一个问题进行删除。');
                    event.preventDefault(); 
                    return;
                }
                if (!confirm(`您确定要永久删除选中的 ${selectedCount} 个问题吗？此操作不可撤销。`)) {
                    event.preventDefault(); 
                }
            }
        });
    }
});
</script>
{% endblock %}