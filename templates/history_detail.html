<!-- templates/history_detail.html -->
<!DOCTYPE html>
<html lang="zh-CN" class="light-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史评估详情 - {{ history_record.timestamp.strftime('%Y年%m月%d日 %H:%M:%S') }}</title>
    
    <!-- 字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- 图标 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <!-- 科技风格CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tech-style.css') }}">
    <!-- 浅色主题CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/light-theme.css') }}">
    
    <style>
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--tech-bg-card);
            border: 1px solid var(--tech-border);
            border-radius: 0.5rem;
            color: var(--tech-text-secondary);
            text-decoration: none;
            transition: var(--tech-transition);
            margin-bottom: 2rem;
        }
        
        .back-button:hover {
            background: var(--tech-bg-hover);
            color: var(--tech-accent-cyan);
            border-color: var(--tech-accent-cyan);
            transform: translateX(-5px);
        }

        .score-bar {
            width: 100px;
            height: 8px;
            background: var(--tech-bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            display: inline-block;
            margin-left: 10px;
        }
        
        .score-fill {
            height: 100%;
            background: var(--tech-gradient-1);
            border-radius: 4px;
            transition: width 0.6s ease;
            position: relative;
        }

        .model-link {
            color: #000000;
            text-decoration: none;
            transition: var(--tech-transition);
            position: relative;
        }
        
        .model-link:hover {
            color: #808080;
            text-shadow: 0 0 10px currentColor;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            margin: -0.75rem;
        }
        
        .col-lg-8 {
            flex: 0 0 66.666667%;
            max-width: 66.666667%;
            padding: 0.75rem;
        }
        
        .col-lg-4 {
            flex: 0 0 33.333333%;
            max-width: 33.333333%;
            padding: 0.75rem;
        }

        .quadrant-legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--tech-bg-secondary);
            border-radius: 0.5rem;
            border: 1px solid var(--tech-border);
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }
        
        .legend-text {
            font-size: 0.875rem;
        }
        
        .legend-title {
            color: var(--tech-text-primary);
            font-weight: 600;
        }
        
        .legend-desc {
            color: var(--tech-text-muted);
            font-size: 0.75rem;
        }

        .time-header {
            background: var(--tech-bg-card);
            border: 1px solid var(--tech-border);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .time-title {
            font-size: 2rem;
            font-weight: 700;
            background: var(--tech-gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .time-subtitle {
            color: var(--tech-text-muted);
            font-size: 1rem;
        }
        /* 排序相关样式 */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: var(--tech-transition);
        }
        
        .sortable-header:hover {
            background: var(--tech-bg-hover);
            color: var(--tech-accent-cyan);
        }
        
        .sort-indicator {
            margin-left: 0.5rem;
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .sort-indicator.active {
            opacity: 1;
            color: var(--tech-accent-cyan);
        }
        
        .sort-indicator.asc::after {
            content: '▲';
        }
        
        .sort-indicator.desc::after {
            content: '▼';
        }
    </style>
</head>
<body>
    <header class="tech-header">
        <div class="tech-container">
            <a href="{{ url_for('history.evaluation_history') }}" class="back-button">
                <i class="bi bi-chevron-left"></i>
                返回历史记录
            </a>
            
            <div class="time-header">
                <h1 class="time-title">{{ history_record.timestamp.strftime('%Y年%m月%d日 %H:%M:%S') }}</h1>
                <p class="time-subtitle">历史评估记录快照 #{{ history_record.id }}</p>
            </div>
        </div>
    </header>

    <div class="tech-container">
        <!-- Flash 消息 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="tech-card {% if category == 'danger' %}flash-danger{% else %}flash-success{% endif %}" style="margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span>{{ message }}</span>
                            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: var(--tech-text-secondary); cursor: pointer;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if leaderboard %}
        <!-- 详细数据表 -->
        <div class="tech-card">
            <h3 class="tech-card-title">
                模型评估详细数据
            </h3>
            <div style="overflow-x: auto;">
                <table class="tech-table">
                    <thead>
                        <tr>
                            <th style="text-align: center;">总得分排名</th>
                            <th>模型名称</th>
                            <th class="sortable-header" onclick="sortTable('avg_score')" style="cursor: pointer;">
                                总得分
                                <span class="sort-indicator {% if current_sort_by == 'avg_score' %}active {{ current_sort_order }}{% endif %}"></span>
                            </th>
                            <th class="sortable-header" onclick="sortTable('response_rate')" style="cursor: pointer;">
                                响应率
                                <span class="sort-indicator {% if current_sort_by == 'response_rate' %}active {{ current_sort_order }}{% endif %}"></span>
                            </th>
                            {% for dim in l1_dimensions %}
                            <th class="sortable-header" onclick="sortTable('dim_{{ dim.id }}')" style="text-align: center; cursor: pointer;">
                                {{ dim.name }}评分
                                <span class="sort-indicator {% if current_sort_by == 'dim_' + dim.id|string %}active {{ current_sort_order }}{% endif %}"></span>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in leaderboard %}
                        <tr>
                            <td style="text-align: center;">
                                <span class="rank-badge rank-other">
                                    {{ item.total_score_rank }}
                                </span>
                            </td>
                            <td>
                                <b>{{ item.name }}</b>
                            </td>
                            <td>
                                <span style="font-weight: 600; color: #000000;">{{ "%.2f%%" | format(item.avg_score / 5 * 100) }}</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: {{ (item.avg_score / 5 * 100)|round(2) }}%"></div>
                                </div>
                            </td>
                            <td>
                                <span style="font-weight: 600; color: #000000;">
                                    {{ "%.2f" | format(item.response_rate) }}%
                                </span>
                            </td>
                            {% for dim in l1_dimensions %}
                            <td style="text-align: center;">
                                {% if item.dim_scores_display.get(dim.id|string, '-') != '-' %}
                                    <span style="font-weight: 600; color: #000000">{{ "%.2f%%" | format(item.dim_scores_display[dim.id|string] / 5 * 100) }}</span>
                                {% else %}
                                    <span style="color: var(--tech-text-muted);">-</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="{{ 4 + (l1_dimensions|length) }}" style="text-align: center; padding: 3rem;">
                                <div class="tech-loader"></div>
                                <p style="margin-top: 1rem; color: var(--tech-text-muted);">暂无评估数据</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="tech-card">
            <h3 class="tech-card-title">
                模型综合性能分析
            </h3>
            <div id="overall-bar-chart" class="tech-chart-container"></div>
        </div>

        <div class="tech-card">
            <h3 class="tech-card-title">
                安全管制策略象限分析
            </h3>
            <div class="row">
                <div class="col-lg-8">
                    <div id="quadrant-chart" class="tech-chart-container"></div>
                </div>
                <div class="col-lg-4">
                    <div style="padding: 1rem;">
                        <h5 style="color: var(--tech-text-primary); margin-bottom: 1rem;">象限说明</h5>
                        <div class="quadrant-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #7282d6;"></div>
                                <div>
                                    <div class="legend-title">稳健型管制</div>
                                    <div class="legend-desc">代表模型内容审核严格、回复开放性低。</div>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #41eded;"></div>
                                <div>
                                    <div class="legend-title">粗放型管制</div>
                                    <div class="legend-desc">代表模型内容审核宽松、回复开放性高;</div>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #89b1fe;"></div>
                                <div>
                                    <div class="legend-title">精细化管制</div>
                                    <div class="legend-desc">代表模型内容审核严格、回复开放性高;</div>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #3fc1eb;"></div>
                                <div>
                                    <div class="legend-title">松懈型管制</div>
                                    <div class="legend-desc">代表模型内容审核宽松、回复开放性低;</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tech-card">
            <h3 class="tech-card-title">
                各模型维度平均分对比
            </h3>
            <div id="dimension-bar-chart" class="tech-chart-container"></div>
        </div>
        {% endif %}

    </div>

    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    
    <script>
    // 从后端传递的数据
    window.leaderboardData = {{ leaderboard|tojson|safe }};
    window.dimensions = {{ l1_dimensions|tojson|safe }};
    window.scoreThreshold = {{ score_threshold }};
    window.rateThreshold = {{ rate_threshold }};
    window.currentSortBy = '{{ current_sort_by }}';
    window.currentSortOrder = '{{ current_sort_order }}';
    </script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const leaderboardData = window.leaderboardData;
        const dimensions = window.dimensions;
        const scoreThreshold = window.scoreThreshold;
        const rateThreshold = window.rateThreshold;
        
        if (!leaderboardData || leaderboardData.length === 0) return;

        // 存储所有图表实例
        let charts = {};

        const initCharts = () => {
            // 使用主题切换器提供的主题
            const techTheme = {
                color: [
                    '#41eded', '#3fc1eb', '#89b1fe', '#7282d6', '#5a8fff',
                    '#6b7bff', '#4dcfff', '#8a6dff', '#3dd4f7', '#9085ff'
                ],
                backgroundColor: 'transparent',
                textStyle: { color: '#000000' },
                title: { textStyle: { color: '#000000' } },
                legend: { textStyle: { color: '#000000' } },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    borderColor: 'rgba(203, 213, 225, 0.7)',
                    textStyle: { color: '#000000' }
                },
                grid: { borderColor: 'rgba(203, 213, 225, 0.3)' },
                categoryAxis: {
                    axisLine: { lineStyle: { color: 'rgba(203, 213, 225, 0.7)' } },
                    axisTick: { lineStyle: { color: 'rgba(203, 213, 225, 0.7)' } },
                    axisLabel: { color: '#000000' },
                    splitLine: { lineStyle: { color: ['rgba(203, 213, 225, 0.3)'] } }
                },
                valueAxis: {
                    axisLine: { lineStyle: { color: 'rgba(203, 213, 225, 0.7)' } },
                    axisTick: { lineStyle: { color: 'rgba(203, 213, 225, 0.7)' } },
                    axisLabel: { color: '#000000' },
                    splitLine: { lineStyle: { color: ['rgba(203, 213, 225, 0.3)'] } }
                }
            };

            // 1. 综合性能柱状图
            const overallChartDom = document.getElementById('overall-bar-chart');
            if (overallChartDom) {
                if (charts.overallChart) {
                    charts.overallChart.dispose();
                }
                
                charts.overallChart = echarts.init(overallChartDom, techTheme);
                const overallOption = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        },
                        formatter: function (params) {
                            let res = params[0].name + '<br/>';
                            params.forEach(function (item) {
                                res += item.marker + ' ' + item.seriesName + ' : ' + item.value.toFixed(2) + '%<br/>';
                            });
                            return res;
                        }
                    },
                    legend: {
                        data: ['总得分', '响应率'],
                        top: 10
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        top: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: leaderboardData.map(item => item.name),
                        axisLabel: {
                            interval: 0,
                            rotate: 30
                        }
                    },
                    yAxis: [
                        {
                            type: 'value',
                            name: '得分 (%)',
                            min: 0,
                            max: 100,
                            position: 'left',
                            axisLabel: {
                                formatter: '{value}%'
                            }
                        },
                        {
                            type: 'value',
                            name: '响应率',
                            min: 0,
                            max: 100,
                            position: 'right',
                            axisLabel: {
                                formatter: '{value}%'
                            },
                            splitLine: {
                                show: false
                            }
                        }
                    ],
                    series: [
                        {
                            name: '总得分',
                            type: 'bar',
                            data: leaderboardData.map(item => ({
                                value: parseFloat(item.avg_score / 5 * 100),
                                itemStyle: {
                                    color: {
                                        type: 'linear',
                                        x: 0,
                                        y: 0,
                                        x2: 0,
                                        y2: 1,
                                        colorStops: [{
                                            offset: 0, color: techTheme.color[0]
                                        }, {
                                            offset: 1, color: techTheme.color[0] + '80'
                                        }]
                                    }
                                }
                            })),
                            emphasis: {
                                focus: 'series'
                            }
                        },
                        {
                            name: '响应率',
                            type: 'line',
                            yAxisIndex: 1,
                            data: leaderboardData.map(item => parseFloat(item.response_rate.toFixed(2))),
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 8,
                            lineStyle: {
                                width: 3,
                                color: techTheme.color[2]
                            },
                            itemStyle: {
                                color: techTheme.color[2],
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            emphasis: {
                                focus: 'series'
                            }
                        }
                    ]
                };
                charts.overallChart.setOption(overallOption);
            }

            // 2. 四象限图
            const quadrantChartDom = document.getElementById('quadrant-chart');
            if (quadrantChartDom) {
                if (charts.quadrantChart) {
                    charts.quadrantChart.dispose();
                }
                
                charts.quadrantChart = echarts.init(quadrantChartDom, techTheme);
                
                const quadrantOption = {
                    grid: {
                        left: '10%',
                        right: '10%',
                        bottom: '10%',
                        top: '10%'
                    },
                    tooltip: {
                        formatter: params => {
                            if (params.componentType === 'series' && params.seriesType === 'scatter') {
                                return `${params.value[2]}<br/>响应率: ${params.value[0].toFixed(2)}%<br/>总得分: ${params.value[1].toFixed(2)}%`;
                            }
                            return '';
                        }
                    },
                    xAxis: {
                        name: '响应率 (%)',
                        nameLocation: 'middle',
                        nameGap: 30,
                        min: 80,
                        max: 100,
                        splitLine: {
                            show: false
                        }
                    },
                    yAxis: {
                        name: '总得分 (%)',
                        nameLocation: 'middle',
                        nameGap: 40,
                        min: 40,
                        max: 80,
                        axisLabel: {
                            formatter: '{value}%'
                        },
                        splitLine: {
                            show: false
                        }
                    },
                    series: [
                        // 分割线
                        {
                            type: 'line',
                            markLine: {
                                silent: true,
                                symbol: 'none',
                                lineStyle: {
                                    type: 'dashed',
                                    color: techTheme.categoryAxis.axisLine.lineStyle.color,
                                    width: 2
                                },
                                data: [
                                    { xAxis: rateThreshold },
                                    { yAxis: scoreThreshold * 20 }
                                ],
                                label: {
                                    show: false
                                }
                            }
                        },
                        // 象限背景
                        {
                            type: 'custom',
                            renderItem: function(params, api) {
                                const xStart = api.coord([api.value(0), api.value(1)]);
                                const xEnd = api.coord([api.value(2), api.value(3)]);
                                const rectShape = echarts.graphic.clipRectByRect({
                                    x: xStart[0],
                                    y: xStart[1],
                                    width: xEnd[0] - xStart[0],
                                    height: xEnd[1] - xStart[1]
                                }, {
                                    x: params.coordSys.x,
                                    y: params.coordSys.y,
                                    width: params.coordSys.width,
                                    height: params.coordSys.height
                                });
                                return rectShape && {
                                    type: 'rect',
                                    shape: rectShape,
                                    style: api.style()
                                };
                            },
                            data: [
                                {value: [rateThreshold, scoreThreshold * 20, 100, 80], itemStyle: {color: techTheme.color[3] + '20'}},
                                {value: [85, scoreThreshold * 20, rateThreshold, 80], itemStyle: {color: techTheme.color[0] + '20'}},
                                {value: [rateThreshold, 40, 100, scoreThreshold * 20], itemStyle: {color: techTheme.color[4] + '20'}},
                                {value: [85, 40, rateThreshold, scoreThreshold * 20], itemStyle: {color: techTheme.color[2] + '20'}}
                            ]
                        },
                        // 散点数据
                        {
                            name: '模型分布',
                            type: 'scatter',
                            symbolSize: 20,
                            data: leaderboardData.map(item => [
                                item.response_rate,
                                item.avg_score * 20,
                                item.name
                            ]),
                            itemStyle: {
                                color: params => {
                                    const [x, y] = params.value;
                                    if (x >= rateThreshold && y >= scoreThreshold * 20) return techTheme.color[3];
                                    if (x < rateThreshold && y >= scoreThreshold * 20) return techTheme.color[0];
                                    if (x >= rateThreshold && y < scoreThreshold * 20) return techTheme.color[4];
                                    return techTheme.color[2];
                                },
                                borderColor: '#fff',
                                borderWidth: 2,
                                shadowBlur: 10,
                                shadowColor: 'rgba(0, 0, 0, 0.3)'
                            },
                            emphasis: {
                                scale: 1.5,
                                itemStyle: {
                                    shadowBlur: 20
                                }
                            },
                            label: {
                                show: true,
                                formatter: function(params) {
                                    return params.data[2];
                                },
                                position: 'top',
                                fontSize: 12,
                                fontWeight: 'bold',
                                color: techTheme.textStyle.color,
                                textBorderColor: 'transparent',
                                textBorderWidth: 0,
                                textShadowColor: 'transparent',
                                textShadowBlur: 0
                            },
                        }
                    ]
                };
                
                charts.quadrantChart.setOption(quadrantOption);
            }

            // 3. 维度对比图
            const dimensionChartDom = document.getElementById('dimension-bar-chart');
            if (dimensionChartDom && dimensions && dimensions.length > 0) {
                if (charts.dimensionChart) {
                    charts.dimensionChart.dispose();
                }
                
                charts.dimensionChart = echarts.init(dimensionChartDom, techTheme);
                
                const allModels = leaderboardData;
                const modelNames = allModels.map(m => m.name);

                const seriesData = dimensions.map((dim, index) => {
                    return {
                        name: dim.name,
                        type: 'bar',
                        barGap: '20%',
                        emphasis: {
                            focus: 'series'
                        },
                        data: allModels.map(model => {
                            const scoreData = model.dim_scores[dim.id.toString()];
                            return scoreData ? parseFloat(scoreData.avg * 20) : 0;
                        }),
                        itemStyle: {
                            color: techTheme.color[[0, 2, 4, 6, 8, 1, 3, 5, 7, 9][index % 10]]
                        }
                    };
                });

                const dimensionOption = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        },
                        formatter: function (params) {
                            let res = params[0].name + '<br/>';
                            params.forEach(function (item) {
                                res += item.marker + ' ' + item.seriesName + ' : ' + item.value.toFixed(2) + '%<br/>';
                            });
                            return res;
                        }
                    },
                    legend: {
                        data: dimensions.map(d => d.name),
                        top: 10
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        top: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: modelNames,
                        axisLabel: {
                            interval: 0,
                            rotate: 30
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '平均得分 (%)',
                        min: 0,
                        max: 100,
                        axisLabel: {
                            formatter: '{value}%'
                        }
                    },
                    series: seriesData
                };
                
                charts.dimensionChart.setOption(dimensionOption);
            }

            // 响应式
            window.addEventListener('resize', () => {
                Object.values(charts).forEach(chart => {
                    if (chart) chart.resize();
                });
            });
        };

        // 初始化图表
        initCharts();
    });
    </script>

    <footer style="text-align: center; padding: 3rem 0; color: var(--tech-text-muted);">
        <p>AI模型综合能力评估系统 © 2024</p>
    </footer>
    <script>
    // 表格排序功能
    function sortTable(column) {
        const currentSortBy = window.currentSortBy;
        const currentSortOrder = window.currentSortOrder;
        
        let newSortOrder = 'desc'; // 默认倒序
        
        // 如果点击的是当前排序列，则切换排序顺序
        if (currentSortBy === column) {
            newSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
        }
        
        // 构建新的URL
        const url = new URL(window.location);
        url.searchParams.set('sort_by', column);
        url.searchParams.set('sort_order', newSortOrder);
        
        // 跳转到新URL
        window.location.href = url.toString();
    }
    </script>
</body>
</html>