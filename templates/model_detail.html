<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ llm.name }} - 模型详情</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .header { background-color: #6c757d; color: white; padding: 2rem 0; margin-bottom: 2rem; }
        .chart-container { width: 100%; height: 450px; }
        .model-icon { max-width: 80px; max-height: 80px; margin-right: 1.5rem; }
    </style>
</head>
<body>

    <header class="header text-center">
        <div class="container">
            <h1 class="display-4">{{ llm.name }}</h1>
            <p class="lead">模型详情分析</p>
        </div>
    </header>

    <div class="container">
        <div class="card shadow-sm mb-4">
            <div class="card-body d-flex align-items-center">
                {% if llm.icon %}
                    <img src="{{ url_for('static', filename=config.UPLOAD_FOLDER.split('static/')[1] + '/' + llm.icon) }}" alt="{{ llm.name }} Icon" class="model-icon rounded-circle">
                {% else %}
                    <div class="model-icon bg-secondary rounded-circle d-flex align-items-center justify-content-center text-white fs-1">
                        <i class="bi bi-robot"></i>
                    </div>
                {% endif %}
                <div>
                    <h4 class="card-title mb-1">{{ llm.name }}</h4>
                    <span class="badge bg-primary">总排名: {{ model_rank }}</span>
                </div>
            </div>
            <div class="card-body border-top">
                <h5>模型描述</h5>
                <p>{{ llm.desc or '暂无描述。' }}</p>
                <hr>
                <h5>综合评价</h5>
                <p>{{ llm.comment or '暂无评价。' }}</p>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">综合能力雷达图</h5>
                        <div id="radar-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">一级维度得分比例</h5>
                        <!-- 解决方案 3: 将 div 的 ID 从 bar-chart 改为 pie-chart -->
                        <div id="proportion-pie-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4">
             <a href="{{ url_for('public_leaderboard.display_public_leaderboard') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left-circle"></i> 返回综合榜单
            </a>
        </div>
    </div>

    <footer class="text-center py-4 mt-5">
        <p class="mb-0 text-muted">大模型风险评估系统</p>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Chart 1: Radar Chart ---
        const radarChartDom = document.getElementById('radar-chart');
        const radarChart = echarts.init(radarChartDom);
        const radarData = {{ radar_data|tojson }};
        const radarOption = {
            tooltip: { 
                trigger: 'item',
                // 解决方案 1: 添加 formatter 函数格式化浮点数
                formatter: function(params) {
                    let tooltipStr = `${params.name}<br/>`;
                    const indicators = radarData.indicators;
                    const values = params.data.value;
                    for (let i = 0; i < indicators.length; i++) {
                        // 将值格式化为两位小数
                        tooltipStr += `${indicators[i].name}: ${values[i].toFixed(2)}<br/>`;
                    }
                    return tooltipStr;
                }
            },
            radar: {
                indicator: radarData.indicators
            },
            series: [{
                name: '{{ llm.name }}',
                type: 'radar',
                data: [{
                    value: radarData.values,
                    name: '{{ llm.name }}'
                }]
            }]
        };
        radarChart.setOption(radarOption);

        // --- 解决方案 2 & 3: 将块状图替换为饼图 ---
        const pieChartDom = document.getElementById('proportion-pie-chart');
        const pieChart = echarts.init(pieChartDom);
        const pieData = {{ bar_data|tojson }}; // 后端数据结构(bar_data)同样适用于饼图
        
        const pieOption = {
            tooltip: {
                trigger: 'item',
                // 格式化 tooltip，正确显示名称、得分和百分比
                formatter: '{a} <br/>{b}: {c} ({d}%)' // {a}系列名, {b}数据名, {c}值, {d}百分比
            },
            legend: {
                orient: 'vertical',
                left: 'left'
            },
            series: [{
                name: '得分来源',
                type: 'pie',
                radius: '60%', // 饼图大小
                center: ['50%', '55%'], // 饼图位置
                data: pieData, // 直接使用后端传来的数据
                emphasis: {
                    // 悬浮放大效果
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                },
                label: {
                    // 在饼图上显示维度名和百分比
                    show: true,
                    formatter: '{b}\n({d}%)'
                }
            }]
        };
        pieChart.setOption(pieOption);

        // 确保图表在窗口大小改变时自适应
        window.addEventListener('resize', function() {
            radarChart.resize();
            pieChart.resize(); // 确保新的 pieChart 也能自适应
        });
    });
    </script>

</body>
</html>