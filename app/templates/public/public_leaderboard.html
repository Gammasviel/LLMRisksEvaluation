<!-- templates/public_leaderboard.html -->
<!DOCTYPE html>
<html lang="zh-CN" class="light-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI模型综合能力评估系统</title>
    
    <!-- 字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- 图标 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <!-- 科技风格CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tech-style.css') }}">
    <!-- 新增：浅色主题CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/light-theme.css') }}">
    
    <style>
        /* 页面特定样式 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .stat-card {
            background: var(--tech-bg-card);
            border: 1px solid var(--tech-border);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            transition: var(--tech-transition);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--tech-gradient-2);
            border-radius: 1rem;
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease;
        }
        
        .stat-card:hover::before {
            opacity: 0.1;
        }
        
        .stat-card:hover {
            background: var(--tech-bg-hover);
            transform: translateY(-5px);
            border-color: var(--tech-accent-purple);
        }
        
        .stat-card:hover .stat-value {
            text-shadow: 0 0 20px currentColor;
        }
        
        .stat-card:hover .stat-label {
            color: var(--tech-text-primary);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--tech-gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s ease;
        }
        
        .stat-label {
            color: var(--tech-text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 0.5rem;
            transition: color 0.3s ease;
        }
        
        .model-link {
            color: #000000;
            text-decoration: none;
            transition: var(--tech-transition);
            position: relative;
        }
        
        .model-link:hover {
            color: #808080;
            text-shadow: 0 0 10px currentColor;
        }
        
        .score-bar {
            width: 100%;
            height: 8px;
            background: var(--tech-bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .score-fill {
            height: 100%;
            background: var(--tech-gradient-1);
            border-radius: 4px;
            transition: width 0.6s ease;
            position: relative;
        }
        
        .update-button {
            position: fixed;
            bottom: 5.5rem;
            right: 2rem;
            z-index: 999; /* 降低z-index，让主题切换按钮在上方 */
        }
        
        .quadrant-legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--tech-bg-secondary);
            border-radius: 0.5rem;
            border: 1px solid var(--tech-border);
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }
        
        .legend-text {
            font-size: 0.875rem;
        }
        
        .legend-title {
            color: var(--tech-text-primary);
            font-weight: 600;
        }
        
        .legend-desc {
            color: var(--tech-text-muted);
            font-size: 0.75rem;
        }
        
        /* 优化row和col布局 */
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: -0.75rem;
        }
        
        .col-lg-8 {
            flex: 0 0 66.666667%;
            max-width: 66.666667%;
            padding: 0.75rem;
        }
        
        .col-lg-4 {
            flex: 0 0 33.333333%;
            max-width: 33.333333%;
            padding: 0.75rem;
        }
        
        /* 排序相关样式 */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: var(--tech-transition);
        }
        
        .sortable-header:hover {
            background: var(--tech-bg-hover);
            color: var(--tech-accent-cyan);
        }
        
        .sort-indicator {
            margin-left: 0.5rem;
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .sort-indicator.active {
            opacity: 1;
            color: var(--tech-accent-cyan);
        }
        
        .sort-indicator.asc::after {
            content: '▲';
        }
        
        .sort-indicator.desc::after {
            content: '▼';
        }
        
        /* 导航链接样式 */
        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--tech-gradient-1);
            border: none;
            border-radius: 0.5rem;
            color: white;
            text-decoration: none;
            font-weight: 600;
            transition: var(--tech-transition);
        }
        
        .nav-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(65, 237, 237, 0.3);
        }
        
        /* Flash消息样式 */
        .flash-danger {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .flash-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }

        /* --- 新增Tab样式 --- */
        .tabs {
            border-bottom: 1px solid var(--tech-border);
            margin-bottom: 1.5rem;
            display: flex;
        }

        .tab-link {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            color: var(--tech-text-secondary);
            font-size: 1rem;
            font-weight: 500;
            transition: var(--tech-transition);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .tab-link:hover {
            color: var(--tech-accent-cyan);
        }

        .tab-link.active {
            color: var(--tech-accent-cyan);
            border-bottom-color: var(--tech-accent-cyan);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }
        
        @media (max-width: 1024px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* --- 结束Tab样式 --- */
    </style>
    
</head>
<body>
    <header class="tech-header">
        <div class="tech-container">
            <h1 class="neon-text">AI模型综合能力评估系统</h1>
        </div>
    </header>

    <div class="tech-container">
        <!-- Flash 消息 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="tech-card {% if category == 'danger' %}flash-danger{% else %}flash-success{% endif %}" style="margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span>{{ message }}</span>
                            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: var(--tech-text-secondary); cursor: pointer;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if leaderboard %}
        <!-- 详细数据表 -->
        <div class="tech-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 class="tech-card-title" style="margin: 0;">
                    模型评估详细数据
                </h3>
                <a href="{{ url_for('history.evaluation_history') }}" class="nav-link" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                    <i class="bi bi-clock-history"></i>
                    查看历史记录
                </a>
            </div>
            <div style="overflow-x: auto;">
                <table class="tech-table">
                    <thead>
                        <tr>
                            <th style="text-align: center;">总得分排名</th>
                            <th>模型名称</th>
                            <th class="sortable-header" onclick="sortTable('avg_score')" style="cursor: pointer;">
                                总得分
                                <span class="sort-indicator {% if current_sort_by == 'avg_score' %}active {{ current_sort_order }}{% endif %}"></span>
                            </th>
                            <th class="sortable-header" onclick="sortTable('response_rate')" style="cursor: pointer;">
                                响应率
                                <span class="sort-indicator {% if current_sort_by == 'response_rate' %}active {{ current_sort_order }}{% endif %}"></span>
                            </th>
                            {% for dim in l1_dimensions %}
                            <th class="sortable-header" onclick="sortTable('dim_{{ dim.id }}')" style="text-align: center; cursor: pointer;">
                                {{ dim.name }}评分
                                <span class="sort-indicator {% if current_sort_by == 'dim_' + dim.id|string %}active {{ current_sort_order }}{% endif %}"></span>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in leaderboard %}
                        <tr>
                            <td style="text-align: center;">
                                <span class="rank-badge rank-other">
                                    {{ item.total_score_rank }}
                                </span>
                            </td>
                            <td>
                                <a href="{{ url_for('model_detail.model_detail', model_name=item.name) }}" class="model-link">
                                    <b>{{ item.name }}</b>
                                </a>
                            </td>
                            <td>
                                <span style="font-weight: 600; color: #000000;">{{ "%.2f%%" | format(item.avg_score / 5 * 100) }}</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: {{ (item.avg_score / 5 * 100)|round(2) }}%"></div>
                                </div>
                            </td>
                            <td>
                                <span style="font-weight: 600; color: #000000;">
                                    {{ "%.2f" | format(item.response_rate) }}%
                                </span>
                            </td>
                            {% for dim in l1_dimensions %}
                            <td style="text-align: center;">
                                {% if item.dim_scores_display.get(dim.id, '-') != '-' %}
                                    <span style="font-weight: 600; color: #000000">{{ "%.2f%%" | format(item.dim_scores_display[dim.id] / 5 * 100) }}</span>
                                {% else %}
                                    <span style="color: var(--tech-text-muted);">-</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="{{ 4 + (l1_dimensions|length) }}" style="text-align: center; padding: 3rem;">
                                <div class="tech-loader"></div>
                                <p style="margin-top: 1rem; color: var(--tech-text-muted);">暂无评估数据</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="tech-card">
            <h3 class="tech-card-title">
                模型综合性能分析
            </h3>
            <div id="overall-bar-chart" class="tech-chart-container"></div>
        </div>

        <div class="tech-card">
            <h3 class="tech-card-title">
                安全管制策略象限分析
            </h3>
            <div class="row">
                <div class="col-lg-8">
                    <div id="quadrant-chart" class="tech-chart-container"></div>
                </div>
                <div class="col-lg-4">
                    <div style="padding: 1rem;">
                        <h5 style="color: var(--tech-text-primary); margin-bottom: 1rem;">象限说明</h5>
                        <div class="quadrant-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #58dedf;"></div>
                                <div>
                                    <div class="legend-title">稳健型管制</div>
                                    <div class="legend-desc">代表模型内容审核严格、回复开放性低。</div>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #7e8acc;"></div>
                                <div>
                                    <div class="legend-title">精细化管制</div>
                                    <div class="legend-desc">代表模型内容审核严格、回复开放性高;</div>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #90afeb;"></div>
                                <div>
                                    <div class="legend-title">粗放型管制</div>
                                    <div class="legend-desc">代表模型内容审核宽松、回复开放性高;</div>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #6b93ec;"></div>
                                <div>
                                    <div class="legend-title">松懈型管制</div>
                                    <div class="legend-desc">代表模型内容审核宽松、回复开放性低;</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tech-card">
            <h3 class="tech-card-title">
                各模型维度平均分对比
            </h3>
            <div id="dimension-bar-chart" class="tech-chart-container"></div>
        </div>
        
        <div class="tech-card">
            <h3 class="tech-card-title">
                各模型题型分析
            </h3>
            <div id="question-type-bar-chart" class="tech-chart-container"></div>
        </div>
        
        <!-- --- 新增开始: Model-specific analysis tabs --- -->
        {% if charts_data %}
        <div class="tech-card">
            <h3 class="tech-card-title">各模型维度详细分析</h3>
            <div class="tabs">
                {% for model_name in charts_data.keys() %}
                    <button class="tab-link" onclick="openTab(event, '{{ model_name }}')">{{ model_name }}</button>
                {% endfor %}
            </div>

            {% for model_name, data in charts_data.items() %}
            <div id="{{ model_name }}" class="tab-content">
                <!-- 图表区域 - 使用chart-grid布局 -->
                <div class="chart-grid">
                    <div class="tech-card">
                        <h3 class="tech-card-title">各维度响应率分析</h3>
                        <div id="response-rate-chart-{{ model_name }}" class="tech-chart-container"></div>
                    </div>
                    
                    <div class="tech-card">
                        <h3 class="tech-card-title">各维度得分分析</h3>
                        <div id="avg-score-chart-{{ model_name }}" class="tech-chart-container"></div>
                    </div>
                </div>
                
                <!-- Bias Analysis for this model -->
                {% if data.bias_analysis_data %}
                <div class="tech-card">
                    <h3 class="tech-card-title">模型价值观与公平性分析 (偏见歧视分析)</h3>
                    <div style="overflow-x: auto;">
                        <table class="tech-table">
                            <thead>
                                <tr>
                                    <th>评估维度</th>
                                    <th>平均得分</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bias_item in data.bias_analysis_data %}
                                <tr>
                                    <td style="font-weight: 600;">{{ bias_item.name }}</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <span style="font-weight: 600; color: #000000; min-width: 60px;">{{ "%.2f%%" | format(bias_item.avg_score / 5 * 100) }}</span>
                                            <div class="score-bar">
                                                <div class="score-fill" style="width: {{ (bias_item.avg_score / 5 * 100)|round(2) }}%"></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <!-- --- 新增结束 --- -->

        {% endif %}

    </div>

    <!-- 更新按钮 -->
    <div class="update-button">
        <form method="POST" action="{{ url_for('public_leaderboard.update_all_models') }}" onsubmit="return confirm('确定要重新评估所有模型吗？这将是一个耗时的操作。');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="tech-btn">
                <i class="bi bi-arrow-repeat"></i> 更新全部模型
            </button>
        </form>
    </div>

    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    
    <script>
    // 从后端传递的数据
    window.leaderboardData = {{ leaderboard|tojson|safe }};
    window.dimensions = {{ l1_dimensions|tojson|safe }};
    window.scoreThreshold = {{ score_threshold }};
    window.rateThreshold = {{ rate_threshold }};
    window.currentSortBy = '{{ current_sort_by }}';
    window.currentSortOrder = '{{ current_sort_order }}';
    window.chartsData = {{ charts_data|tojson|safe }};
    </script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const leaderboardData = window.leaderboardData;
        const dimensions = window.dimensions;
        const scoreThreshold = window.scoreThreshold;
        const rateThreshold = window.rateThreshold;
        
        if (!leaderboardData || leaderboardData.length === 0) return;

        window.charts = {};
        const techTheme = {
            color: [
                '#41eded', '#3fc1eb', '#89b1fe', '#7282d6', '#5a8fff',
                '#6b7bff', '#4dcfff', '#8a6dff', '#3dd4f7', '#9085ff'
            ],
            backgroundColor: 'transparent',
            textStyle: { color: '#000000' },
            title: { textStyle: { color: '#000000' } },
            legend: { textStyle: { color: '#000000' } },
            tooltip: {
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: 'rgba(203, 213, 225, 0.7)',
                textStyle: { color: '#000000' }
            },
            grid: { borderColor: 'rgba(203, 213, 225, 0.3)' },
            categoryAxis: {
                axisLine: { lineStyle: { color: 'rgba(203, 213, 225, 0.7)' } },
                axisTick: { lineStyle: { color: 'rgba(203, 213, 225, 0.7)' } },
                axisLabel: { color: '#000000' },
                splitLine: { lineStyle: { color: ['rgba(203, 213, 225, 0.3)'] } }
            },
            valueAxis: {
                axisLine: { lineStyle: { color: 'rgba(203, 213, 225, 0.7)' } },
                axisTick: { lineStyle: { color: 'rgba(203, 213, 225, 0.7)' } },
                axisLabel: { color: '#000000' },
                splitLine: { lineStyle: { color: ['rgba(203, 213, 225, 0.3)'] } }
            }
        };
        window.techTheme = techTheme;


        const initMainCharts = () => {
            const goToModelDetail = (modelName) => {
                if (modelName) {
                    window.location.href = `/model/detail/${encodeURIComponent(modelName)}`;
                }
            };

            // 1. 综合性能柱状图
            const overallChartDom = document.getElementById('overall-bar-chart');
            if (overallChartDom) {
                if (charts.overallChart) charts.overallChart.dispose();
                charts.overallChart = echarts.init(overallChartDom, techTheme);
                const overallOption = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'cross' },
                        formatter: (params) => params.map(p => `${p.marker} ${p.seriesName}: ${p.value.toFixed(2)}%`).join('<br>')
                    },
                    legend: { data: ['总得分', '响应率'], top: 10 },
                    grid: { left: '3%', right: '4%', bottom: '15%', top: '15%', containLabel: true },
                    xAxis: {
                        type: 'category',
                        data: leaderboardData.map(item => item.name),
                        axisLabel: { interval: 0, rotate: 30 },
                        triggerEvent: true
                    },
                    yAxis: [{ type: 'value', name: '百分比', min: 0, max: 100, axisLabel: { formatter: '{value}%' } }],
                    series: [
                        {
                            name: '总得分',
                            type: 'bar',
                            data: leaderboardData.map(item => parseFloat(item.avg_score / 5 * 100)),
                            emphasis: { focus: 'series' }
                        },
                        {
                            name: '响应率',
                            type: 'bar',
                            data: leaderboardData.map(item => parseFloat(item.response_rate.toFixed(2))),
                            emphasis: { focus: 'series' }
                        }
                    ]
                };
                charts.overallChart.setOption(overallOption);
                charts.overallChart.on('click', params => {
                    if (params.name) goToModelDetail(params.name);
                });
            }

            // 2. 四象限图
            const quadrantChartDom = document.getElementById('quadrant-chart');
            if (quadrantChartDom) {
                if (charts.quadrantChart) charts.quadrantChart.dispose();
                charts.quadrantChart = echarts.init(quadrantChartDom, techTheme);
                const quadrantOption = {
                    grid: { left: '10%', right: '10%', bottom: '10%', top: '10%' },
                    tooltip: {
                        formatter: params => `${params.value[2]}<br/>响应率: ${params.value[0].toFixed(2)}%<br/>总得分: ${params.value[1].toFixed(2)}%`
                    },
                    xAxis: { name: '响应率 (%)', nameLocation: 'middle', nameGap: 30, min: 80, max: 100, splitLine: { show: false } },
                    yAxis: { name: '总得分 (%)', nameLocation: 'middle', nameGap: 40, min: 50, max: 80, axisLabel: { formatter: '{value}%' }, splitLine: { show: false } },
                    series: [
                        {
                            type: 'line',
                            markLine: {
                                silent: true,
                                symbol: 'none',
                                lineStyle: { type: 'dashed', color: techTheme.categoryAxis.axisLine.lineStyle.color, width: 2 },
                                data: [{ xAxis: rateThreshold }, { yAxis: scoreThreshold * 20 }],
                                label: { show: false }
                            }
                        },
                        {
                            name: '模型分布',
                            type: 'scatter',
                            symbolSize: 20,
                            data: leaderboardData.map(item => [item.response_rate, item.avg_score * 20, item.name]),
                            itemStyle: { borderColor: '#fff', borderWidth: 2, shadowBlur: 10, shadowColor: 'rgba(0, 0, 0, 0.3)' },
                            label: { show: true, formatter: p => p.data[2], position: 'top', fontSize: 12, fontWeight: 'bold' }
                        }
                    ]
                };
                charts.quadrantChart.setOption(quadrantOption);
                charts.quadrantChart.on('click', params => {
                    if (params.seriesType === 'scatter') goToModelDetail(params.value[2]);
                });
            }

            // 3. 维度对比图
            const dimensionChartDom = document.getElementById('dimension-bar-chart');
            if (dimensionChartDom && dimensions && dimensions.length > 0) {
                if (charts.dimensionChart) charts.dimensionChart.dispose();
                charts.dimensionChart = echarts.init(dimensionChartDom, techTheme);
                const dimensionOption = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' },
                        formatter: (params) => params[0].name + '<br/>' + params.map(p => `${p.marker} ${p.seriesName}: ${p.value.toFixed(2)}%`).join('<br>')
                    },
                    legend: { data: dimensions.map(d => d.name), top: 10 },
                    grid: { left: '3%', right: '4%', bottom: '3%', top: '15%', containLabel: true },
                    xAxis: { type: 'category', data: leaderboardData.map(m => m.name), axisLabel: { interval: 0, rotate: 30 } },
                    yAxis: { type: 'value', name: '平均得分 (%)', min: 0, max: 100, axisLabel: { formatter: '{value}%' } },
                    series: dimensions.map((dim, index) => ({
                        name: dim.name,
                        type: 'bar',
                        barGap: '20%',
                        emphasis: { focus: 'series' },
                        data: leaderboardData.map(model => parseFloat(model.dim_scores[dim.id].avg * 20))
                    }))
                };
                charts.dimensionChart.setOption(dimensionOption);
            }

            // 4. 客观题与主观题得分对比图
            const questionTypeChartDom = document.getElementById('question-type-bar-chart');
            if (questionTypeChartDom) {
                if (charts.questionTypeChart) charts.questionTypeChart.dispose();
                charts.questionTypeChart = echarts.init(questionTypeChartDom, techTheme);
                const questionTypeOption = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' },
                        formatter: (params) => params[0].name + '<br/>' + params.map(p => `${p.marker} ${p.seriesName}: ${p.value.toFixed(2)}%`).join('<br>')
                    },
                    legend: { data: ['客观题得分', '主观题得分'], top: 10 },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: { type: 'value', name: '平均得分 (%)', min: 0, max: 100, axisLabel: { formatter: '{value}%' } },
                    yAxis: { type: 'category', data: leaderboardData.map(item => item.name), axisLabel: { interval: 0 } },
                    series: [
                        { name: '客观题得分', type: 'bar', barGap: '20%', emphasis: { focus: 'series' }, data: leaderboardData.map(item => parseFloat((item.avg_obj_score / 5 * 100).toFixed(2))) },
                        { name: '主观题得分', type: 'bar', emphasis: { focus: 'series' }, data: leaderboardData.map(item => parseFloat((item.avg_subj_score / 5 * 100).toFixed(2))) }
                    ]
                };
                charts.questionTypeChart.setOption(questionTypeOption);
            }

            window.addEventListener('resize', () => Object.values(charts).forEach(chart => chart && chart.resize()));
        };

        initMainCharts();

        const firstTab = document.querySelector(".tab-link");
        if (firstTab) {
            firstTab.click();
        }
    });
    
    function openTab(evt, modelName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-link");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(modelName).style.display = "block";
        evt.currentTarget.className += " active";

        const chartsData = window.chartsData;
        if (!chartsData || !chartsData[modelName]) return;

        const modelChartData = chartsData[modelName];
        const techTheme = window.techTheme;
        let charts = window.charts;

        // 响应率雷达图
        const responseRateChartName = `responseRate_${modelName}`;
        if (!charts[responseRateChartName]) {
            const dom = document.getElementById(`response-rate-chart-${modelName}`);
            if(dom) {
                const chart = echarts.init(dom, techTheme);
                const responseRateData = modelChartData.response_rate_by_dimension;
                const option = {
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            let tooltipContent = '<strong>' + params.name + '</strong><br/>';
                            const values = params.data.value;
                            const indicators = responseRateData.labels;
                            indicators.forEach((indicator, index) => {
                                tooltipContent += indicator + ': ' + values[index].toFixed(2) + '%<br/>';
                            });
                            return tooltipContent;
                        }
                    },
                    legend: { data: ['响应率'], orient: 'vertical', right: 10, top: 20 },
                    radar: {
                        indicator: responseRateData.labels.map(name => ({ name: name, max: 100 })),
                        radius: '60%',
                        center: ['50%', '55%'],
                        axisName: { show: true, color: '#000', fontWeight: 'bold' }
                    },
                    series: [{
                        name: '响应率',
                        type: 'radar',
                        label: { show: true, fontWeight: 'bold', formatter: (params) => params.value.toFixed(2) + '%' },
                        data: [{ value: responseRateData.datasets[0].data, name: '响应率' }]
                    }]
                };
                chart.setOption(option);
                charts[responseRateChartName] = chart;
            }
        }

        // 得分分析图
        const avgScoreChartName = `avgScore_${modelName}`;
        if (!charts[avgScoreChartName]) {
            const dom = document.getElementById(`avg-score-chart-${modelName}`);
            if(dom) {
                const chart = echarts.init(dom, techTheme);
                const scoreData = modelChartData.avg_scores_by_dimension;

                const processedScoreData = scoreData.datasets[0].data.map((value, index) => {
                    const percentageValue = (value / 5 * 100);
                    return {
                        name: scoreData.labels[index],
                        value: percentageValue,
                        originalScore: value,
                        itemStyle: {
                            color: techTheme.color[index % techTheme.color.length]
                        }
                    };
                });

                const option = {
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            return `
                                <div style="font-weight: 600; margin-bottom: 4px;">${params.data.name}</div>
                                <div>得分: ${(params.data.originalScore / 5 * 100).toFixed(2)}%</div>
                            `;
                        }
                    },
                    polar: {
                        radius: ['20%', '80%']
                    },
                    radiusAxis: {
                        type: 'category',
                        data: processedScoreData.map(item => item.name),
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        axisTick: { show: false }
                    },
                    angleAxis: {
                        type: 'value',
                        max: 360,
                        startAngle: 90,
                        clockwise: true,
                        axisLabel: {
                            show: true,
                            formatter: function(value) {
                                const percentage = (value * 100 / 270);
                                return percentage <= 100 ? percentage.toFixed(0) + '%' : '';
                            },
                            fontSize: 10,
                            color: '#000000'
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: 'rgba(203, 213, 225, 0.3)',
                                width: 1
                            }
                        },
                        axisLine: { show: false },
                        axisTick: { show: false }
                    },
                    series: [{
                        type: 'bar',
                        coordinateSystem: 'polar',
                        data: processedScoreData.map(item => ({
                            ...item,
                            value: item.value * 270 / 100
                        })),
                        barWidth: '60%',
                        roundCap: true,
                        label: {
                            show: true,
                            position: 'start',
                            distance: 15,
                            formatter: function(params) {
                                return `${params.data.name} ${(params.data.originalScore / 5 * 100).toFixed(2)}%`;
                            },
                            fontSize: 11,
                            fontWeight: 'bold',
                            color: techTheme.textStyle.color,
                            align: 'right'
                        }
                    }]
                };
                chart.setOption(option);
                charts[avgScoreChartName] = chart;
            }
        }

        setTimeout(() => {
            if (charts[responseRateChartName]) charts[responseRateChartName].resize();
            if (charts[avgScoreChartName]) charts[avgScoreChartName].resize();
        }, 10);
    }
    
    function sortTable(column) {
        const currentSortBy = window.currentSortBy;
        const currentSortOrder = window.currentSortOrder;
        let newSortOrder = (currentSortBy === column && currentSortOrder === 'desc') ? 'asc' : 'desc';
        const url = new URL(window.location);
        url.searchParams.set('sort_by', column);
        url.searchParams.set('sort_order', newSortOrder);
        window.location.href = url.toString();
    }
    </script>
    {% include 'public/back_to_top.html' %}
</body>
</html>
