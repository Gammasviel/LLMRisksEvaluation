<!-- templates/history_detail.html -->
<!DOCTYPE html>
<html lang="zh-CN" class="light-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史评估详情 - {{ history_record.timestamp.strftime('%Y年%m月%d日 %H:%M:%S') }}</title>
    
    <!-- 字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- 图标 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <!-- 科技风格CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tech-style.css') }}">
    <!-- 浅色主题CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/light-theme.css') }}">
    
    <style>
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--tech-bg-card);
            border: 1px solid var(--tech-border);
            border-radius: 0.5rem;
            color: var(--tech-text-secondary);
            text-decoration: none;
            transition: var(--tech-transition);
            margin-bottom: 2rem;
        }
        
        .back-button:hover {
            background: var(--tech-bg-hover);
            color: var(--tech-accent-cyan);
            border-color: var(--tech-accent-cyan);
            transform: translateX(-5px);
        }

        .score-bar {
            width: 100px;
            height: 8px;
            background: var(--tech-bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            display: inline-block;
            margin-left: 10px;
        }
        
        .score-fill {
            height: 100%;
            background: var(--tech-gradient-1);
            border-radius: 4px;
            transition: width 0.6s ease;
            position: relative;
        }

        .model-link {
            color: #000000;
            text-decoration: none;
            transition: var(--tech-transition);
            position: relative;
        }
        
        .model-link:hover {
            color: #808080;
            text-shadow: 0 0 10px currentColor;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            margin: -0.75rem;
        }
        
        .col-lg-8 {
            flex: 0 0 66.666667%;
            max-width: 66.666667%;
            padding: 0.75rem;
        }
        
        .col-lg-4 {
            flex: 0 0 33.333333%;
            max-width: 33.333333%;
            padding: 0.75rem;
        }

        .quadrant-legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--tech-bg-secondary);
            border-radius: 0.5rem;
            border: 1px solid var(--tech-border);
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }
        
        .legend-text {
            font-size: 0.875rem;
        }
        
        .legend-title {
            color: var(--tech-text-primary);
            font-weight: 600;
        }
        
        .legend-desc {
            color: var(--tech-text-muted);
            font-size: 0.75rem;
        }

        .time-header {
            background: var(--tech-bg-card);
            border: 1px solid var(--tech-border);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .time-title {
            font-size: 2rem;
            font-weight: 700;
            background: var(--tech-gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .time-subtitle {
            color: var(--tech-text-muted);
            font-size: 1rem;
        }
        /* 排序相关样式 */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: var(--tech-transition);
        }
        
        .sortable-header:hover {
            background: var(--tech-bg-hover);
            color: var(--tech-accent-cyan);
        }
        
        .sort-indicator {
            margin-left: 0.5rem;
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .sort-indicator.active {
            opacity: 1;
            color: var(--tech-accent-cyan);
        }
        
        .sort-indicator.asc::after {
            content: '▲';
        }
        
        .sort-indicator.desc::after {
            content: '▼';
        }

        /* Tab styles */
        .tabs {
            border-bottom: 1px solid var(--tech-border);
            margin-bottom: 1.5rem;
            display: flex;
        }

        .tab-link {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            color: var(--tech-text-secondary);
            font-size: 1rem;
            font-weight: 500;
            transition: var(--tech-transition);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .tab-link:hover {
            color: var(--tech-accent-cyan);
        }

        .tab-link.active {
            color: var(--tech-accent-cyan);
            border-bottom-color: var(--tech-accent-cyan);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }
        
        @media (max-width: 1024px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <header class="tech-header">
        <div class="tech-container">
            <a href="{{ url_for('history.evaluation_history') }}" class="back-button">
                <i class="bi bi-chevron-left"></i>
                返回历史记录
            </a>
            
            <div class="time-header">
                <h1 class="time-title">{{ history_record.timestamp.strftime('%Y年%m月%d日 %H:%M:%S') }}</h1>
                <p class="time-subtitle">历史评估记录快照 #{{ history_record.id }}</p>
            </div>
        </div>
    </header>

    <div class="tech-container">
        <!-- Flash 消息 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="tech-card {% if category == 'danger' %}flash-danger{% else %}flash-success{% endif %}" style="margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span>{{ message }}</span>
                            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: var(--tech-text-secondary); cursor: pointer;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if leaderboard %}
        <!-- 详细数据表 -->
        <div class="tech-card">
            <h3 class="tech-card-title">
                模型评估详细数据
            </h3>
            <div style="overflow-x: auto;">
                <table class="tech-table">
                    <thead>
                        <tr>
                            <th style="text-align: center;">总得分排名</th>
                            <th>模型名称</th>
                            <th class="sortable-header" onclick="sortTable('avg_score')" style="cursor: pointer;">
                                总得分
                                <span class="sort-indicator {% if current_sort_by == 'avg_score' %}active {{ current_sort_order }}{% endif %}"></span>
                            </th>
                            <th class="sortable-header" onclick="sortTable('response_rate')" style="cursor: pointer;">
                                响应率
                                <span class="sort-indicator {% if current_sort_by == 'response_rate' %}active {{ current_sort_order }}{% endif %}"></span>
                            </th>
                            {% for dim in l1_dimensions %}
                            <th class="sortable-header" onclick="sortTable('dim_{{ dim.id }}')" style="text-align: center; cursor: pointer;">
                                {{ dim.name }}评分
                                <span class="sort-indicator {% if current_sort_by == 'dim_' + dim.id|string %}active {{ current_sort_order }}{% endif %}"></span>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in leaderboard %}
                        <tr>
                            <td style="text-align: center;">
                                <span class="rank-badge rank-other">
                                    {{ item.total_score_rank }}
                                </span>
                            </td>
                            <td>
                                <b>{{ item.name }}</b>
                            </td>
                            <td>
                                <span style="font-weight: 600; color: #000000;">{{ "%.2f%%" | format(item.avg_score / 5 * 100) }}</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: {{ (item.avg_score / 5 * 100)|round(2) }}%"></div>
                                </div>
                            </td>
                            <td>
                                <span style="font-weight: 600; color: #000000;">
                                    {{ "%.2f" | format(item.response_rate) }}%
                                </span>
                            </td>
                            {% for dim in l1_dimensions %}
                            <td style="text-align: center;">
                                {% if item.dim_scores_display.get(dim.id|string, '-') != '-' %}
                                    <span style="font-weight: 600; color: #000000">{{ "%.2f%%" | format(item.dim_scores_display[dim.id|string] / 5 * 100) }}</span>
                                {% else %}
                                    <span style="color: var(--tech-text-muted);">-</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="{{ 4 + (l1_dimensions|length) }}" style="text-align: center; padding: 3rem;">
                                <div class="tech-loader"></div>
                                <p style="margin-top: 1rem; color: var(--tech-text-muted);">暂无评估数据</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="tech-card">
            <h3 class="tech-card-title">
                模型综合性能分析
            </h3>
            <div id="overall-bar-chart" class="tech-chart-container"></div>
        </div>

        <div class="tech-card">
            <h3 class="tech-card-title">
                安全管制策略象限分析
            </h3>
            <div class="row">
                <div class="col-lg-8">
                    <div id="quadrant-chart" class="tech-chart-container"></div>
                </div>
                <div class="col-lg-4">
                    <div style="padding: 1rem;">
                        <h5 style="color: var(--tech-text-primary); margin-bottom: 1rem;">象限说明</h5>
                        <div class="quadrant-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #7282d6;"></div>
                                <div>
                                    <div class="legend-title">稳健型管制</div>
                                    <div class="legend-desc">代表模型内容审核严格、回复开放性低。</div>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #41eded;"></div>
                                <div>
                                    <div class="legend-title">粗放型管制</div>
                                    <div class="legend-desc">代表模型内容审核宽松、回复开放性高;</div>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #89b1fe;"></div>
                                <div>
                                    <div class="legend-title">精细化管制</div>
                                    <div class="legend-desc">代表模型内容审核严格、回复开放性高;</div>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #3fc1eb;"></div>
                                <div>
                                    <div class="legend-title">松懈型管制</div>
                                    <div class="legend-desc">代表模型内容审核宽松、回复开放性低;</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tech-card">
            <h3 class="tech-card-title">
                各模型维度平均分对比
            </h3>
            <div id="dimension-bar-chart" class="tech-chart-container"></div>
        </div>
        
        <!-- --- 新增开始 --- -->
        <div class="tech-card">
            <h3 class="tech-card-title">
                题型分析：各模型客观题与主观题得分对比
            </h3>
            <div id="question-type-bar-chart" class="tech-chart-container"></div>
        </div>
        <!-- --- 新增结束 --- -->
        {% endif %}

        <!-- Model-specific analysis tabs -->
        {% if charts_data %}
        <div class="tech-card">
            <h3 class="tech-card-title">各模型维度详细分析</h3>
            <div class="tabs">
                {% for model_name in charts_data.keys() %}
                    <button class="tab-link" onclick="openTab(event, '{{ model_name }}')">{{ model_name }}</button>
                {% endfor %}
            </div>

            {% for model_name, data in charts_data.items() %}
            <div id="{{ model_name }}" class="tab-content">
                <!-- 图表区域 - 使用chart-grid布局 -->
                <div class="chart-grid">
                    <div class="tech-card">
                        <h3 class="tech-card-title">各维度响应率分析</h3>
                        <div id="response-rate-chart-{{ model_name }}" class="tech-chart-container"></div>
                    </div>
                    
                    <div class="tech-card">
                        <h3 class="tech-card-title">各维度得分分析</h3>
                        <div id="avg-score-chart-{{ model_name }}" class="tech-chart-container"></div>
                    </div>
                </div>
                
                <!-- Bias Analysis for this model -->
                {% for item in leaderboard %}
                    {% if item.name == model_name and item.bias_analysis_data %}
                    <div class="tech-card">
                        <h3 class="tech-card-title">模型价值观与公平性分析 (偏见歧视分析)</h3>
                        <div style="overflow-x: auto;">
                            <table class="tech-table">
                                <thead>
                                    <tr>
                                        <th>评估维度</th>
                                        <th>平均得分</th>
                                        <th style="width: 40%;">表现进度</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for bias_item in item.bias_analysis_data %}
                                    <tr>
                                        <td style="font-weight: 600;">{{ bias_item.name }}</td>
                                        <td>
                                            <span style="font-size: 1.125rem; font-weight: 700; color: #000000;">
                                                {{ "%.2f"|format(bias_item.avg_score) }}
                                            </span>
                                        </td>
                                        <td>
                                            <!-- 假设总分是5分 -->
                                            <div class="tech-progress">
                                                <div class="tech-progress-bar" style="width: {{ (bias_item.avg_score / 5 * 100) }}%"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

    </div>

    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    
    <script>
    // 从后端传递的数据
    window.leaderboardData = {{ leaderboard|tojson|safe }};
    window.dimensions = {{ l1_dimensions|tojson|safe }};
    window.scoreThreshold = {{ score_threshold }};
    window.rateThreshold = {{ rate_threshold }};
    window.currentSortBy = '{{ current_sort_by }}';
    window.currentSortOrder = '{{ current_sort_order }}';
    window.chartsData = {{ charts_data|tojson|safe }};
    </script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const leaderboardData = window.leaderboardData;
        const dimensions = window.dimensions;
        const scoreThreshold = window.scoreThreshold;
        const rateThreshold = window.rateThreshold;
        
        if (!leaderboardData || leaderboardData.length === 0) return;

        window.charts = {};
        window.techTheme = {
            color: [
                '#41eded', '#3fc1eb', '#89b1fe', '#7282d6', '#5a8fff',
                '#6b7bff', '#4dcfff', '#8a6dff', '#3dd4f7', '#9085ff'
            ],
            backgroundColor: 'transparent',
            textStyle: { color: 'var(--tech-text-primary)' },
            title: { textStyle: { color: 'var(--tech-text-primary)' } },
            legend: { textStyle: { color: '#000000' } },
            tooltip: {
                backgroundColor: 'rgba(22, 28, 45, 0.95)',
                borderColor: 'rgba(203, 213, 225, 0.2)',
                textStyle: { color: '#fff' }
            },
            grid: { borderColor: 'rgba(203, 213, 225, 0.1)' },
            categoryAxis: {
                axisLine: { lineStyle: { color: 'rgba(203, 213, 225, 0.3)' } },
                axisTick: { lineStyle: { color: 'rgba(203, 213, 225, 0.5)' } },
                axisLabel: { color: 'var(--tech-text-secondary)' },
                splitLine: { lineStyle: { color: ['rgba(203, 213, 225, 0.1)'] } }
            },
            valueAxis: {
                axisLine: { lineStyle: { color: 'rgba(203, 213, 225, 0.3)' } },
                axisTick: { lineStyle: { color: 'rgba(203, 213, 225, 0.5)' } },
                axisLabel: { color: 'var(--tech-text-secondary)' },
                splitLine: { lineStyle: { color: ['rgba(203, 213, 225, 0.1)'] } }
            }
        };

        const initCharts = () => {
            // 1. 综合性能柱状图
            const overallChartDom = document.getElementById('overall-bar-chart');
            if (overallChartDom) {
                const chart = echarts.init(overallChartDom, window.techTheme);
                const option = {
                    tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                    legend: { data: ['总得分', '响应率'], top: 10 },
                    grid: { left: '3%', right: '4%', bottom: '15%', top: '15%', containLabel: true },
                    xAxis: { type: 'category', data: leaderboardData.map(item => item.name), axisLabel: { interval: 0, rotate: 30 } },
                    yAxis: [
                        { type: 'value', name: '百分比', min: 0, max: 100, axisLabel: { formatter: '{value}%' } }
                    ],
                    series: [
                        { name: '总得分', type: 'bar', data: leaderboardData.map(item => ({ value: parseFloat(item.avg_score / 5 * 100), itemStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: window.techTheme.color[0] }, { offset: 1, color: window.techTheme.color[1] }]) } })), emphasis: { focus: 'series' } },
                        { name: '响应率', type: 'bar', data: leaderboardData.map(item => parseFloat(item.response_rate.toFixed(2))), itemStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: window.techTheme.color[2] }, { offset: 1, color: window.techTheme.color[3] }]) }, emphasis: { focus: 'series' } }
                    ]
                };
                chart.setOption(option);
                window.charts.overallChart = chart;
            }

            // 2. 四象限图 (restoring original logic)
            const quadrantChartDom = document.getElementById('quadrant-chart');
            if (quadrantChartDom) {
                const chart = echarts.init(quadrantChartDom, window.techTheme);
                const option = {
                    grid: { left: '10%', right: '10%', bottom: '10%', top: '10%' },
                    tooltip: { formatter: params => `${params.value[2]}<br/>响应率: ${params.value[0].toFixed(2)}%<br/>总得分: ${params.value[1].toFixed(2)}%` },
                    xAxis: { name: '响应率 (%)', nameLocation: 'middle', nameGap: 30, min: 80, max: 100, splitLine: { show: false } },
                    yAxis: { name: '总得分 (%)', nameLocation: 'middle', nameGap: 40, min: 50, max: 80, axisLabel: { formatter: '{value}%' }, splitLine: { show: false } },
                    series: [
                        { type: 'line', markLine: { silent: true, symbol: 'none', lineStyle: { type: 'dashed', color: 'rgba(203, 213, 225, 0.7)', width: 2 }, data: [{ xAxis: rateThreshold }, { yAxis: scoreThreshold * 20 }], label: { show: false } } },
                        { name: '模型分布', type: 'scatter', symbolSize: 20, data: leaderboardData.map(item => [item.response_rate, item.avg_score * 20, item.name]), itemStyle: { borderColor: '#fff', borderWidth: 2, shadowBlur: 10, shadowColor: 'rgba(0, 0, 0, 0.3)' }, label: { show: true, formatter: params => params.data[2], position: 'top', fontSize: 12, fontWeight: 'bold' } }
                    ]
                };
                chart.setOption(option);
                window.charts.quadrantChart = chart;
            }

            // 3. 维度对比图 (restoring original logic)
            const dimensionChartDom = document.getElementById('dimension-bar-chart');
            if (dimensionChartDom && dimensions && dimensions.length > 0) {
                const chart = echarts.init(dimensionChartDom, window.techTheme);
                const seriesData = dimensions.map((dim, index) => ({
                    name: dim.name,
                    type: 'bar',
                    barGap: '20%',
                    emphasis: { focus: 'series' },
                    data: leaderboardData.map(model => {
                        const scoreData = model.dim_scores[dim.id.toString()] || model.dim_scores[dim.id];
                        return scoreData ? parseFloat(scoreData.avg * 20) : 0;
                    }),
                    itemStyle: { color: window.techTheme.color[[0, 2, 4, 6, 8, 1, 3, 5, 7, 9][index % 10]] }
                }));
                const option = {
                    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                    legend: { data: dimensions.map(d => d.name), top: 10 },
                    grid: { left: '3%', right: '4%', bottom: '3%', top: '15%', containLabel: true },
                    xAxis: { type: 'category', data: leaderboardData.map(item => item.name), axisLabel: { interval: 0, rotate: 30 } },
                    yAxis: { type: 'value', name: '平均得分 (%)', min: 0, max: 100, axisLabel: { formatter: '{value}%' } },
                    series: seriesData
                };
                chart.setOption(option);
                window.charts.dimensionChart = chart;
            }

            // 4. 客观题与主观题得分对比图 (restoring original logic)
            const questionTypeChartDom = document.getElementById('question-type-bar-chart');
            if (questionTypeChartDom) {
                const chart = echarts.init(questionTypeChartDom, window.techTheme);
                const option = {
                    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                    legend: { data: ['客观题得分', '主观题得分'], top: 10 },
                    grid: { left: '3%', right: '4%', bottom: '15%', top: '15%', containLabel: true },
                    xAxis: { type: 'category', data: leaderboardData.map(item => item.name), axisLabel: { interval: 0, rotate: 30 } },
                    yAxis: { type: 'value', name: '平均得分 (%)', min: 0, max: 100, axisLabel: { formatter: '{value}%' } },
                    series: [
                        { name: '客观题得分', type: 'bar', barGap: '20%', emphasis: { focus: 'series' }, data: leaderboardData.map(item => parseFloat(((item.avg_obj_score || 0) / 5 * 100).toFixed(2))), itemStyle: { color: window.techTheme.color[0] } },
                        { name: '主观题得分', type: 'bar', emphasis: { focus: 'series' }, data: leaderboardData.map(item => parseFloat(((item.avg_subj_score || 0) / 5 * 100).toFixed(2))), itemStyle: { color: window.techTheme.color[4] } }
                    ]
                };
                chart.setOption(option);
                window.charts.questionTypeChart = chart;
            }
        };

        initCharts();

        const firstTab = document.querySelector(".tab-link");
        if (firstTab) {
            firstTab.click();
        }

        window.addEventListener('resize', () => {
            Object.values(window.charts).forEach(chart => {
                if (chart) chart.resize();
            });
        });
    });

    function openTab(evt, modelName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-link");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(modelName).style.display = "block";
        evt.currentTarget.className += " active";

        const chartsData = window.chartsData;
        if (!chartsData || !chartsData[modelName]) return;

        const modelChartData = chartsData[modelName];
        const techTheme = window.techTheme;
        let charts = window.charts;

        const responseRateChartName = `responseRate_${modelName}`;
        if (!charts[responseRateChartName]) {
            const dom = document.getElementById(`response-rate-chart-${modelName}`);
            if(dom) {
                const chart = echarts.init(dom, techTheme);
                
                // Prepare polar chart data for response rates
                const responseData = modelChartData.response_rate_by_dimension.datasets[0].data.map((value, index) => {
                    return {
                        name: modelChartData.response_rate_by_dimension.labels[index],
                        value: value,  // 直接使用响应率百分比
                        itemStyle: {
                            color: techTheme.color[index % techTheme.color.length]
                        }
                    };
                });

                const option = {
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            return `
                                <div style="font-weight: 600; margin-bottom: 4px;">${params.data.name}</div>
                                <div>响应率: ${(params.data.value * 100 / 270).toFixed(2)}%</div>
                            `;
                        }
                    },
                    polar: {
                        radius: ['20%', '80%']
                    },
                    radiusAxis: {
                        type: 'category',
                        data: responseData.map(item => item.name),
                        axisLabel: {
                            show: false
                        },
                        axisLine: {
                            show: false
                        },
                        axisTick: {
                            show: false
                        }
                    },
                    angleAxis: {
                        type: 'value',
                        max: 360,  // 最大角度为360度
                        startAngle: 90,
                        clockwise: true,
                        axisLabel: {
                            show: true,  // 显示角度刻度标签
                            formatter: function(value) {
                                const percentage = (value * 100 / 270);
                                // 只显示不超过100%的刻度，270度处显示100%
                                return percentage <= 100 ? percentage.toFixed(0) + '%' : '';
                            },
                            fontSize: 10,
                            color: techTheme.textStyle.color
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: 'rgba(203, 213, 225, 0.3)',
                                width: 1
                            }
                        },
                        axisLine: {
                            show: false
                        },
                        axisTick: {
                            show: false
                        }
                    },
                    series: [{
                        type: 'bar',
                        coordinateSystem: 'polar',
                        data: responseData.map(item => ({
                            ...item,
                            value: item.value * 270 / 100  // 将百分比映射到270度
                        })),
                        barWidth: '60%',
                        roundCap: true,
                        label: {
                            show: true,
                            position: 'start',  // 标签位置在起始点
                            distance: 15,       // 标签距离
                            formatter: function(params) {
                                // 使用原始响应率数据进行显示
                                const originalValue = params.data.value * 100 / 270;
                                return `${params.data.name} ${originalValue.toFixed(2)}%`;
                            },
                            fontSize: 11,
                            fontWeight: 'bold',
                            color: '#000000',   // 强制设置为黑色
                            align: 'right'      // 右对齐
                        },
                        emphasis: {
                            label: {
                                color: '#000000'    // 悬停时也保持黑色
                            },
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }]
                };
                chart.setOption(option);
                charts[responseRateChartName] = chart;
            }
        }

        const avgScoreChartName = `avgScore_${modelName}`;
        if (!charts[avgScoreChartName]) {
            const dom = document.getElementById(`avg-score-chart-${modelName}`);
            if(dom) {
                const chart = echarts.init(dom, techTheme);
                
                // Prepare polar chart data for average scores  
                const scoreData = modelChartData.avg_scores_by_dimension.datasets[0].data.map((value, index) => {
                    const percentageValue = (value / 5 * 100); // 将0-5分转换为百分制
                    return {
                        name: modelChartData.avg_scores_by_dimension.labels[index],
                        value: percentageValue, // 存储百分比值
                        originalScore: value, // 保存原始分数
                        itemStyle: {
                            color: techTheme.color[index % techTheme.color.length]
                        }
                    };
                });

                const option = {
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            return `
                                <div style="font-weight: 600; margin-bottom: 4px;">${params.data.name}</div>
                                <div>得分: ${(params.data.originalScore / 5 * 100).toFixed(2)}%</div>
                            `;
                        }
                    },
                    polar: {
                        radius: ['20%', '80%']
                    },
                    radiusAxis: {
                        type: 'category',
                        data: scoreData.map(item => item.name),
                        axisLabel: {
                            show: false
                        },
                        axisLine: {
                            show: false
                        },
                        axisTick: {
                            show: false
                        }
                    },
                    angleAxis: {
                        type: 'value',
                        max: 360,  // 最大角度为360度
                        startAngle: 90,
                        clockwise: true,
                        axisLabel: {
                            show: true,  // 显示角度刻度标签
                            formatter: function(value) {
                                const percentage = (value * 100 / 270);
                                // 只显示不超过100%的刻度，270度处显示100%
                                return percentage <= 100 ? percentage.toFixed(0) + '%' : '';
                            },
                            fontSize: 10,
                            color: techTheme.textStyle.color
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: 'rgba(203, 213, 225, 0.3)',
                                width: 1
                            }
                        },
                        axisLine: {
                            show: false
                        },
                        axisTick: {
                            show: false
                        }
                    },
                    series: [{
                        type: 'bar',
                        coordinateSystem: 'polar',
                        data: scoreData.map(item => ({
                            ...item,
                            value: item.value * 270 / 100  // 将百分制映射到270度
                        })),
                        barWidth: '60%',
                        roundCap: true,
                        label: {
                            show: true,
                            position: 'start',  // 标签位置在起始点
                            distance: 15,       // 标签距离
                            formatter: function(params) {
                                // 使用原始分数数据进行显示（维度得分分析）
                                return `${params.data.name} ${(params.data.originalScore / 5 * 100).toFixed(2)}%`;
                            },
                            fontSize: 11,
                            fontWeight: 'bold',
                            color: '#000000',   // 强制设置为黑色
                            align: 'right'      // 右对齐
                        },
                        emphasis: {
                            label: {
                                color: '#000000'    // 悬停时也保持黑色
                            },
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }]
                };
                chart.setOption(option);
                charts[avgScoreChartName] = chart;
            }
        }

        setTimeout(() => {
            if (charts[responseRateChartName]) charts[responseRateChartName].resize();
            if (charts[avgScoreChartName]) charts[avgScoreChartName].resize();
        }, 10);
    }
    
    // 表格排序功能
    function sortTable(column) {
        const currentSortBy = window.currentSortBy;
        const currentSortOrder = window.currentSortOrder;
        
        let newSortOrder = 'desc'; // 默认倒序
        
        // 如果点击的是当前排序列，则切换排序顺序
        if (currentSortBy === column) {
            newSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
        }
        
        // 构建新的URL
        const url = new URL(window.location);
        url.searchParams.set('sort_by', column);
        url.searchParams.set('sort_order', newSortOrder);
        
        // 跳转到新URL
        window.location.href = url.toString();
    }
    </script>